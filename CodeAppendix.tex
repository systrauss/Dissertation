%
% Modified by Megan Patnott
% Last Change: Jan 18, 2013
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Modified by Sameer Vijay
% Last Change: Tue Jul 26 2005 13:00 CEST
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Sample Notre Dame Thesis/Dissertation
% Using Donald Peterson's ndthesis classfile
%
% Written by Jeff Squyres and Don Peterson
%
% Provided by the Information Technology Committee of
%   the Graduate Student Union
%   http://www.gsu.nd.edu/
%
% Nothing in this document is serious except the format.  :-)
%
% If you have any suggestions, comments, questions, please send e-mail
% to: ndthesis@gsu.nd.edu
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%
% Appendix for Analysis Code
%

\chapter{Analysis Code}
\label{chap:code}

This appendix contains the analysis code used to gate on rootfiles. It was compiled using ROOT 5.34.19, and later ROOT 6.02 libraries. The GCC compiler version 7.1.0. Included in this appendix are the makefiles and example input files for parameters.

There are two codes used for analysis: the coincidence gating, and the code to merge the analysis of the individual runs together. These two codes were written to share multiple elements. The code in this appendix is broken into four sections: the code unique to the coincidence gating, the code unique to the merge code, the shared code between the two, and example input files from the \texttt{user} folder.

The folder structure for the code is in the following list. Some files listed are not used in the merge code, and would not be present in the directory. The topmost bullets are all in the main code directory. 

\begin{itemize}[noitemsep, nolistsep]
    \item README.md
    \item Makefile
    \item QueueScript.sh
    \item include
    \vspace{-5mm}\begin{itemize}[noitemsep, nolistsep, topsep=0pt, label=\textbullet]
        \item Coefficients.h
        \item Constraints.h
        \item Filelist.h
        \item analysis.h
        \item histograms.h
        \item timing.h
    \end{itemize}
    \item logs
    \item src
    \vspace{-5mm}\begin{itemize}[noitemsep, nolistsep, topsep=0pt, label=\textbullet]
        \item Coefficients.cxx
        \item Constraints.cxx
        \item Filelist.cxx
        \item analysis.cxx
        \item histograms.cxx
        \item main.cxx
        \item timing.cxx
    \end{itemize}
    \item user
    \vspace{-5mm}\begin{itemize}[noitemsep, nolistsep, topsep=0pt, label=\textbullet]
        \item BGO.dat
        \item Cut\_Files
        \vspace{-5mm}\begin{itemize}[noitemsep, nolistsep, topsep=0pt, label=\textbullet]
            \item GeCut.dat
            \item SiLiCut.dat
        \end{itemize}
        \item Filelist.dat
        \item GeCoefficients.dat
        \item Run\_by\_Run
        \vspace{-5mm}\begin{itemize}[noitemsep, nolistsep, topsep=0pt, label=\textbullet]
            \item GeCoefficients\_r*.dat
            \item SiLiCoefficients\_r*.dat
        \end{itemize}
        \item SiLiCoefficients.dat
        \item Timing.dat
    \end{itemize}
\end{itemize}

Please note, "logs" is an otherwise empty folder that is used for putting output files from running code on the CRC backend. Should one wish to run code locally in the terminal window, this folder would be unnecessary, and the shell script named "QueueScript.sh" would be adjusted for local use.

\section{Coincidence Code}

The code in this appendix is expressly for the ICEBall-GEORGINA data. The ICEBall-Clovershare data used a different version of the \texttt{evt2root} converter, which no longer required the \texttt{libExpEvent.so} that was generated by the converter. The \texttt{analysis.cxx} file was also changed to reflect the different tree structure created by the converter. While not replicated here, the area of change is referred to in that subsection.

\includecode{md}{README.md}{README.md}{Simple included explanation of code inputs for running.}

\includecode{make}{Makefile}{Makefile}{In this code, CodeDirectory must be replaced with the path to the code directory. \mint{make}|-L/CodeDirectory/libExpEvent.so| could be removed in the Clovershare data due to the converter changes.}

\includecode{bash}{Queuescript.sh}{Queuescript.sh}{This shell script is written for executing the code on the CRC backend computers. It can be used locally by removing the commented lines down to line 9, and replacing \mint{bash}|$SGE_TASK_ID| with the run number. The terms "netID","Nickname","runStart","runEnd", "CodeDirectory","FileOut", "CutFile", and "TimingFile" must all be replaced with the correct information.}

\includecode{c++}{src/main.cxx}{src/main.cxx}{This is the main code that calls all of the subroutines. The gSystem line is necessary to load the library to read the tree structure of the root files. "Directory" and "OutputDirectory" should be replaced with the proper filepaths.}

\includecode{c++}{src/analysis.cxx}{src/analysis.cxx}{This is the main analysis section of the code. The skeleton is built using the MakeClass routine in ROOT.\citep{brun97:_root} If the structure of the tree varies, this is where the changes would reflect, from lines \texttt{154}-\texttt{206}, where the event tree values are assigned to local variables for manipulation in the code.}

\subsection{\texttt{src/analysis.h}}

This header file has not been included, as it is procedurally generated by the MakeClass routine in ROOT. It changes based on the tree directory.

\includecode{c++}{src/histograms.cxx}{src/histograms.cxx}{These are the subroutines for the creation, adding to, and writing to file of the histograms created in the gating process.}

\includecode{c++}{include/histograms.h}{include/histograms.h}{Header file for \texttt{histograms.cxx}.}

\includecode{c++}{src/timing.cxx}{src/timing.cxx}{This is a class for keeping track of the timing gates used between pairs of detectors.}

\includecode{c++}{include/timing.h}{include/timing.h}{Header file for \texttt{timing.cxx}.}

\section{Merge Code}

\includecode{md}{merge/README.md}{README.md}{Simple included explanation of code inputs for running. Includes important commentary on inputs when used in conjunction with the coincidence code.}

\includecode{make}{merge/Makefile}{Makefile}{The compilation code.}

\includecode{c++}{merge/main.cxx}{src/main.cxx}{This is the main code that calls all the subroutines. The main subroutine used is in the histograms code. "\$OutputDirectory\$ must be replaced with the output directory.}

\includecode{c++}{merge/histograms.cxx}{src/histograms.cxx}{This is the code that combines the histograms of the separate files into one.}

\includecode{c++}{merge/histograms.h}{include/histograms.h}{Header file for \texttt{histograms.cxx}.}

\section{Code Shared between Coincidence and Merge}

\includecode{c++}{src/Coefficients.cxx}{src/Coefficients.cxx}{These are the subroutines for reading in calibration coefficients for the Si(Li) and HPGe detectors.}

\includecode{c++}{include/Coefficients.h}{include/Coefficients.h}{Header file for \texttt{Coefficients.cxx}.}

\includecode{c++}{src/Constraints.cxx}{src/Constraints.cxx}{These are the subroutines for reading in coincidence gates for the BGO, Si(Li), and HPGe detectors.}

\includecode{c++}{include/Constraints.h}{include/Constraints.h}{Header file for \texttt{Constraints.cxx}.}

\includecode{c++}{src/Filelist.cxx}{src/Filelist.cxx}{These are the subroutines for reading in the directory to the data, the generalized run name, the file type, and the tree name. The tree name is not used in the merge code.}

\includecode{c++}{include/Filelist.h}{include/Filelist.h}{Header file for \texttt{Filelist.cxx}.}

\section{Example User Files}

\includecode{c++}{user/Filelist.dat}{user/Filelist.dat}{This is read in by the \texttt{Filelist.cxx} subroutines. It includes the path to the raw data files, the name of the tree, and the formatting for the beginning and end of the data files, including the file extension. "DataDirectory" should be replaced with the correct filepath. The comments must be left in for proper spacing to be read by the program.}

\includecode{c++}{user/GeCoefficients.dat}{user/GeCoefficients.dat}{This is read in by the \texttt{Coefficients.cxx} subroutines. It includes the number of HPGe detectors, the polynomial order of the energy calibration, and the energy calibration itself. Coefficients are in order of increasing polynomial ($0^{th}$, $1^{st}$, etc.). It also is set up for segmented detectors, as in the Clovershare runs. In the case of the different tree structure in the Clovershare data, it also contains the start index of the HPGe detectors in the \texttt{evt} tree array. As a special correction function was used on the residuals to deal with the differential non-linearity of the electronics, as discussed in section \ref{sec:clover_electronics} and \ref{sec:non-linearity}, these coefficients are also included. They can be excluded if not needed. The comments must be left in for proper spacing to be read by the program.}

\includecode{c++}{user/SiLiCoefficients.dat}{user/SiLiCoefficients.dat}{This is read in by the \texttt{Coefficients.cxx} subroutines. It includes the number of Si(Li) detectors, the polynomial order of the energy calibration, and the energy calibration itself. Coefficients are in order of increasing polynomial ($0^{th}$, $1^{st}$, etc.). In the case of the different tree structure in the Clovershare data, it also contains the start index  of the Si(Li) detectors in the \texttt{evt} tree array. The comments must be left in for proper spacing to be read by the program.}

\includecode{c++}{user/BGO.dat}{user/BGO.dat}{This is read in by the \texttt{Coefficients.cxx} subroutines. It includes the number of BGO detectors and the thresholds for each detector. In the case of the different tree structure in the Clovershare data, it also contains the start index  of the BGO detectors in the \texttt{evt} tree array. The comments must be left in for proper spacing to be read by the program.}

\includecode{c++}{user/Timing.dat}{user/Timing.dat}{This is read in by the \texttt{Timing.cxx} subroutines. It includes the timing cut for each pairing of detectors. Each pairing has index of each detector and the upper and lower limit of the timing gate. Indexes for detectors start at 0. If the number of detectors is incorrect in either the \texttt{GeCoefficients.cxx} or the \texttt{SiLiCoefficients.cxx}, this file will not be read in correctly. The order of pairing groups (ge-ge, ge-sili, etc.) must be kept the same. The comments must be left in for proper spacing to be read by the program. This file name can be changed so multiple timing files can exist, as the timing file is specified as input when running the program.}

\includecode{c++}{user/Cut_Files/GeCuts.dat}{user/Cut\_Files/GeCuts.dat}{This is read in by the \texttt{Constraints.cxx} subroutines. It includes the number cuts to run on the HPGe detectors. Each cut is then listed as the detector index, the center of the gate, and half the width of the gate. This is done to mirror the centroid and width of peaks, for readability. The comments must be left in for proper spacing to be read by the program. This file name can be changed so multiple timing files can exist, as the timing file is specified as input when running the program.}

\includecode{c++}{user/Cut_Files/SiLiCuts.dat}{user/Cut\_Files/SiLiCuts.dat}{This is read in by the \texttt{Constraints.cxx} subroutines. It includes the number cuts to run on the HPGe detectors. Each cut is then listed as the detector index, the center of the gate, and half the width of the gate. This is done to mirror the centroid and width of peaks, for readability. The comments must be left in for proper spacing to be read by the program. This file name can be changed so multiple timing files can exist, as the timing file is specified as input when running the program.}

\includecode{c++}{user/Run_by_Run/GeCoefficients.dat}{user/Run\_by\_Run/GeCoefficients\_r*.dat}{This is read in by the \texttt{Coefficients.cxx} subroutines. It includes a linear correction for the HPGe detectors based on the run specified where * is in the file name. The run correction is assumed to be linear, and the number of detectors is assumed from the base calibration files. The comments must be left in for proper spacing to be read by the program. This file name can be changed so multiple run files can exist, as the run file is based on the run being analyzed. These files can be excluded and the correction will be set to y=x automatically.}

%\includecode{c++}{}{user/Run\_by\_Run/SiLiCoefficients\_r*.dat}{This is read in by the \texttt{Coefficients.cxx} subroutines. It includes a linear correction for the Si(Li) detectors based on the run specified where * is in the file name. The run correction is assumed to be linear, and the number of detectors is assumed from the base calibration files. The comments must be left in for proper spacing to be read by the program. This file name can be changed so multiple run files can exist, as the run file is based on the run being analyzed. These files can be excluded and the correction will be set to y=x automatically.}